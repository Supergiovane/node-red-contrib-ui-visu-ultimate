<script type="text/javascript">
    RED.nodes.registerType("Light", {
        category: 'dashboard',
        color: 'rgb( 63, 173, 181)',
        defaults: {
            server: { type: "visu-config", required: true },
            // belonging dashboard group
            group: { type: 'ui_group', required: true },
            name: { value: '' },
            order: { value: 0 },
            // width and height of widget
            width: {
                value: 0,
                validate: function (v) {
                    var valid = true
                    var width = v || 0;
                    var currentGroup = $('#node-input-group').val() || this.group;
                    var groupNode = RED.nodes.node(currentGroup);
                    valid = !groupNode || +width <= +groupNode.width;
                    $("#node-input-size").toggleClass("input-error", !valid);
                    return valid;
                }
            },
            iconOn: { value: "" }
           
        },
        inputs: 1,
        outputs: 1,
        icon: "icon.png",
        paletteLabel: "visu-ultimate",
        label: function () { return this.name || "Room Status"; },
        oneditprepare: function () {
            var node = this;
            var oNodeServer = RED.nodes.node($("#node-input-server").val()); // Store the config-node

            // use elementSize to input common widget parameters
            $("#node-input-size").elementSizer({
                width: "#node-input-width",
                height: "#node-input-height",
                group: "#node-input-group"
            });

            // 31/03/2020 Search Helper
            function fullSearch(sourceText, searchString) {
                // This searches for all words in a string
                var aSearchWords = searchString.toLowerCase().split(" ");
                var i = 0;
                for (let index = 0; index < aSearchWords.length; index++) {
                    if (sourceText.toLowerCase().indexOf(aSearchWords[index]) > -1) i += 1;
                }
                return i == aSearchWords.length;
            }
            // Autocomplete suggestion with ETS csv File
            $("#node-input-control").autocomplete({
                minLength: 1,
                source: function (request, response) {
                    $.getJSON("knxUltimatecsv?nodeID=", (data) => {
                        response($.map(data, function (value, key) {
                            var sSearch = (value.ga + " (" + value.devicename + ") DPT" + value.dpt);
                            if (fullSearch(sSearch, request.term)) {
                                return {
                                    label: value.ga + " # " + value.devicename + " # " + value.dpt, // Label for Display
                                    value: value.ga // Value
                                }
                            } else {
                                return null;
                            }
                        }));
                    });
                }, select: function (event, ui) {
                    // Sets Datapoint and device name automatically
                    var sDevName = ui.item.label.split("#")[1].trim();
                    try {
                        sDevName = sDevName.substr(sDevName.indexOf(")") + 1).trim();
                    } catch (error) {
                    }
                    $('#node-input-control').val(sDevName);
                }
            });
            // Autocomplete suggestion with ETS csv File
            $("#node-input-status").autocomplete({
                minLength: 1,
                source: function (request, response) {
                    $.getJSON("knxUltimatecsv?nodeID=", (data) => {
                        response($.map(data, function (value, key) {
                            var sSearch = (value.ga + " (" + value.devicename + ") DPT" + value.dpt);
                            if (fullSearch(sSearch, request.term)) {
                                return {
                                    label: value.ga + " # " + value.devicename + " # " + value.dpt, // Label for Display
                                    value: value.ga // Value
                                }
                            } else {
                                return null;
                            }
                        }));
                    });
                }, select: function (event, ui) {
                    // Sets Datapoint and device name automatically
                    var sDevName = ui.item.label.split("#")[1].trim();
                    try {
                        sDevName = sDevName.substr(sDevName.indexOf(")") + 1).trim();
                    } catch (error) {
                    }
                    $('#node-input-status').val(sDevName);
                }
            });


            // GET A LIST OF SVG AS IMAGES. USEFUL FOR MAKING IconList.md
            // $("#iconList").selectable();
            // $.getJSON('visuUltimategetIcons', (data) => {
            //     data.forEach(ico => {
            //         $("#iconList").append($("<li class=\"ui-state-default\">" + ico.name + "<div style=\"left: 0px; top: 0px;  width: 62px; height: 62px;\">" + ico.svg + "</div></li>"));
            //     });
            // });

            $.getJSON('visuUltimategetOnlyIconNames', (data) => {
                data.forEach(file => {
                    $("#node-input-iconOn").append($("<option></option>")
                        .attr("value", file.filename)
                        .text(file.name))
                });
                $("#node-input-iconOn").val(node.iconO)
            });
                        


        },
        oneditsave: function () {
        },
        oneditresize: function (size) {
        }
    });
</script>


<script type="text/x-red" data-template-name="Light">

    <div class="form-row">
        <label for="node-input-server">
            <i class="fa fa-tag"></i> <span data-i18n="node-input-server"></span>
        </label>
        <input type="text" id="node-input-server" />
    </div>

    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="node-input-name"></span></label>
        <input type="text" id="node-input-name">
    </div>

    <!-- common input elements for dashboard widget -->
    <div class="form-row" id="template-row-group">
        <label for="node-input-group"><i class="fa fa-table"></i> <span data-i18n="template-row-group"></span></label>
        <input type="text" id="node-input-group">
    </div>
    <div class="form-row" id="template-row-size">
        <label><i class="fa fa-object-group"></i> <span data-i18n="template-row-size"></span></label>
        <input type="hidden" id="node-input-width">
        <input type="hidden" id="node-input-height">
        <button class="editor-button" id="node-input-size"></button>
    </div>
    <!-- common input elements for dashboard widget -->


    <div class="form-row">
        <label for="node-input-control"><i class="fa fa-tag"></i> <span data-i18n="node-input-control"></span></label>
        <input type="text" id="node-input-control">
    </div>
    <div class="form-row">
        <label for="node-input-status"><i class="fa fa-tag"></i> <span data-i18n="node-input-status"></span></label>
        <input type="text" id="node-input-status">
    </div>
    <div class="form-row">
        <label for="node-input-iconOn" ><i class="fa fa-tag"></i> <span data-i18n="node-input-iconOn"></span> </label>
        <select id="node-input-iconOn"></select>
        <div class="form-tips" style="margin-top: 11px;background-color:#FFEEEE;text-align:center">
            <b><a target="_blank" href='iconList.md'><span data-i18n="icon-list-link"></span></a></b>
        </div>
    </div>

    

    <!-- <p>
        <style>
            #iconList { list-style-type: none; margin: 1; padding: 1; width: 100%;}
            #iconList li { margin: 0px; padding: 0px; float: left; width: 104px; height: 104px; font-size: 0.8em; text-align: center; background: dimgray; color: lightgray;}
        </style>
        <ol id="iconList"></ol>
    </p> -->
   


</script>